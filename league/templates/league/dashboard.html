{% extends "league/base.html" %}
{% load static %}
{% block content %}
<script defer src="{% static 'js/dashboard.js' %}"></script>
{% if show_points_tiles %}
<div class="row g-3 mb-3 dashboard-first-row">
  <!-- Left: Profile / quick info -->
  <div class="col-12 col-lg-4">
    <a href="{% url 'profile_edit' %}" class="text-decoration-none text-reset tile-link h-100">
      <div class="card glass-card h-100 tile-tall">
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-4">
          <div class="avatar mb-3" aria-hidden="true">
            {% with fn=request.user.first_name|default:request.user.username ln=request.user.last_name %}
              {{ fn|first|default:"R" }}{{ ln|first|default:"L" }}
            {% endwith %}
          </div>
          <h5 class="card-title mb-1 card-title--lined">
            <i class="bi bi-person-fill me-2" aria-hidden="true"></i>
            Hello{% if request.user.is_authenticated and request.user.player_profile %}, {{ request.user.player_profile.first_name }}{% endif %}
          </h5>
          <div class="text-muted small mb-3">Welcome back to Royals Industrial League</div>
          <div class="w-100 small text-start max-420">
            <div class="d-flex justify-content-between"><span class="text-muted">Username</span><span>{{ request.user.username }}</span></div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Email</span>
              <span>
                {{ request.user.email|default:"—" }}
                {% with prefs=request.user.notificationpreference %}
                {% if prefs and prefs.email_enabled %}
                  <i class="bi bi-envelope-fill text-primary ms-1 small" data-bs-toggle="tooltip" title="Notifications enabled!" aria-hidden="true"></i>
                {% endif %}
                {% endwith %}
              </span>
            </div>
            {% with prefs=request.user.notificationpreference %}
              {% if prefs and prefs.phone_verified_at and prefs.phone_e164 %}
              <div class="d-flex justify-content-between">
                <span class="text-muted">Mobile Phone</span>
                <span>
                  {{ prefs.phone_e164 }}
                  {% if prefs and prefs.sms_enabled %}
                    <i class="bi bi-chat-dots-fill text-primary ms-1 small" data-bs-toggle="tooltip" title="Notifications enabled!" aria-hidden="true"></i>
                  {% endif %}
                </span>
              </div>
              {% else %}
              <div class="d-flex justify-content-between"><span class="text-muted">Mobile Phone</span><span>—</span></div>
              {% endif %}
            {% endwith %}

          </div>
          <div class="mt-3">
            <span class="btn btn-outline-primary btn-sm">Edit Profile</span>
          </div>
        </div>
      </div>
    </a>
  </div>

  <!-- Middle: stack My Points and Team Points -->
  <div class="col-12 col-lg-4">
    <div class="d-flex flex-column gap-3 h-100">
      <a href="{% url 'my_results' %}" class="text-decoration-none text-reset tile-link flex-fill h-100">
        <div class="card glass-card h-100">
          <div class="card-body d-flex flex-column">
            <div>
              <h5 class="card-title mb-2 text-start card-title--lined">
                <i class="bi bi-trophy me-2" aria-hidden="true"></i>
                My Points{% if active_season %} ({{ active_season }}){% endif %}
              </h5>
              <div class="small text-muted mb-2 text-start">
                Season: <span class="badge bg-secondary-subtle text-dark">{{ active_season|default:"—" }}</span>
              </div>
            </div>
            <div class="flex-grow-1 d-flex align-items-center justify-content-center flex-column">
              <div class="display-3 fw-bold text-primary big-number skeleton" data-skel="number">{{ my_points_total|default:"0" }}</div>
              {% if recent_results %}
              <div class="trend mt-2" aria-label="Recent results">
                {% for r in recent_results|slice:":5" %}
                  <span class="trend-chip {% if r == 'W' %}win{% elif r == 'L' %}loss{% else %}tie{% endif %}"></span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </a>

      <a href="{% url 'schedule_list' %}" class="text-decoration-none text-reset tile-link flex-fill h-100">
        <div class="card glass-card h-100">
          <div class="card-body d-flex flex-column">
            <div>
              <h5 class="card-title mb-2 text-start card-title--lined">
                <i class="bi bi-people me-2" aria-hidden="true"></i>
                Total Team Points{% if active_season %} ({{ active_season }}){% endif %}
              </h5>
              <div class="small text-muted mb-2 text-start">
                Season: <span class="badge bg-secondary-subtle text-dark">{{ active_season|default:"—" }}</span>
              </div>
            </div>
            <div class="flex-grow-1 d-flex align-items-center justify-content-center">
              <div class="display-3 fw-bold text-primary big-number skeleton" data-skel="number">{{ team_points_total|default:"0" }}</div>
            </div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- Right: My Record (donut) -->
  <div class="col-12 col-lg-4">
    <a href="{% url 'my_results' %}" class="text-decoration-none text-reset tile-link h-100">
      <div class="card glass-card h-100 tile-tall">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0 card-title--lined">
              <i class="bi bi-graph-up me-2" aria-hidden="true"></i>
              My Record{% if active_season %} ({{ active_season }}){% endif %}
            </h5>
          </div>
          <div id="my-record-empty" class="empty-state" role="status" aria-live="polite">
            <div class="empty-icon" aria-hidden="true"><i class="bi bi-emoji-neutral"></i></div>
            <div class="empty-text">No match results yet</div>
            <div class="empty-sub">Once you have results, your record will appear here.</div>
          </div>
          <div class="donut-wrap position-relative skeleton" data-skel="donut">
            <div id="myRecordChart" role="img" aria-label="Season record donut showing wins, losses, and ties"
                 data-wins="{{ record_wins|default:0 }}"
                 data-losses="{{ record_losses|default:0 }}"
                 data-ties="{{ record_ties|default:0 }}"
                 class="donut-chart"></div>
            <div id="myRecordCenter" class="donut-center fw-bold">0</div>
            <div id="myRecordCenterSub" class="donut-center-sub">Wins</div>
            <div class="donut-hit" aria-hidden="true">
              <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" class="donut-svg">
                <!-- Three concentric arcs used only for hover interaction -->
                <circle id="arc-win"  class="donut-arc" cx="50" cy="50" r="40" fill="none" stroke="transparent" stroke-width="20" transform="rotate(-90 50 50)"/>
                <circle id="arc-loss" class="donut-arc" cx="50" cy="50" r="40" fill="none" stroke="transparent" stroke-width="20" transform="rotate(-90 50 50)"/>
                <circle id="arc-tie"  class="donut-arc" cx="50" cy="50" r="40" fill="none" stroke="transparent" stroke-width="20" transform="rotate(-90 50 50)"/>
              </svg>
            </div>
          </div>
          <div id="myRecordLegend" class="small text-muted d-none">
            <span class="legend-item" data-key="win">
              <span class="legend-swatch bg-primary"></span> Win
            </span>
            <span class="legend-item" data-key="loss">
              <span class="legend-swatch bg-danger"></span> Loss
            </span>
            <span class="legend-item" data-key="tie">
              <span class="legend-swatch bg-secondary"></span> Tie
            </span>
          </div>
        </div>
      </div>
    </a>
  </div>
</div>
{% endif %}
<div class="row g-3">
  <!-- Left column: stack Last Match over League Standings -->
  <div class="col-12 col-md-6 d-flex flex-column gap-3">
    {% if previous %}
      <div class="card glass-card position-relative" data-href="{% url 'fixture_detail' previous.id %}" role="link" tabindex="0">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>
            Last Match: {{ previous }}
            {% if previous.is_bye %}
              <span class="badge bg-secondary ms-2">BYE</span>
            {% elif previous.lineup %}
              {% if previous.lineup.published %}
                <span class="badge bg-success ms-2">Published</span>
              {% else %}
                <span class="badge bg-secondary ms-2">Draft</span>
              {% endif %}
            {% endif %}
          </h5>

          <p class="mb-2">
            {% with lineup_cnt=previous.slot_scores.all|length sub_cnt=previous.sub_results.all|length %}
              {% if lineup_cnt|add:"0" > 0 or sub_cnt|add:"0" > 0 %}
                <span class="text-muted me-2">Results available{% if previous.is_bye %} (BYE){% endif %}</span>
                {% if previous_result_text %}
                  <span class="{{ previous_result_class|default:'' }}">{{ previous_result_text }}</span>
                {% elif sub_cnt|add:"0" > 0 %}
                  <span class="text-muted">—</span>
                {% endif %}
                {% if previous_sub_points|default:0|add:"0" > 0 %}
                  <span class="badge bg-primary ms-2">+{{ previous_sub_points }} sub pts</span>
                {% endif %}
              {% else %}
                <span class="text-muted">No results yet.</span>
              {% endif %}
            {% endwith %}
          </p>

          <a class="stretched-link" href="{% url 'fixture_detail' previous.id %}" aria-label="Open fixture details: {{ previous }}"></a>
        </div>
      </div>
    {% endif %}

    {% if league_standings %}
      <div class="card glass-card">
        <div class="card-body">
          <h5 class="card-title mb-2 card-title--lined">
            <i class="bi bi-trophy-fill me-2" aria-hidden="true"></i>
            League Standings{% if active_season %} ({{ active_season }}){% endif %}
          </h5>
          <div class="table-responsive table-scroll-70">
            <table class="table table-hover align-middle mb-0 glass-table table-glass-transparent table-compact">
              <thead class="table-head-glass">
                <tr>
                  <th scope="col" class="col-rank text-muted" style="width:2.5rem;">#</th>
                  <th scope="col" class="col-team">Team</th>
                  <th scope="col" class="col-points text-end text-nowrap" style="width:1%;">Points</th>
                </tr>
              </thead>
              <tbody>
                {% for row in league_standings %}
                  <tr>
                    <td class="text-muted">{{ forloop.counter }}.</td>
                    <td>
                      {{ row.team_name }}
                      {% if row.is_royals %}
                        <span class="badge bg-primary ms-1">Royals</span>
                      {% endif %}
                    </td>
                    <td class="text-end fw-semibold text-nowrap">{{ row.points|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Right column: Next Match -->
  {% if upcoming %}
  <div class="col-12 col-md-6">
    <div class="card glass-card h-100 position-relative" data-href="{% url 'fixture_detail' upcoming.id %}" role="link" tabindex="0">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>
          Next Match: {{ upcoming }}
          {% if upcoming.is_bye %}
            <span class="badge bg-secondary ms-2">BYE</span>
          {% elif upcoming.lineup %}
            {% if upcoming.lineup.published %}
              <span class="badge bg-success ms-2">Published</span>
            {% else %}
              <span class="badge bg-secondary ms-2">Draft</span>
            {% endif %}
          {% endif %}
        </h5>
        {% if upcoming.is_bye %}
          <div class="alert alert-info py-2 mb-2">Bye week — no availability is needed.</div>
        {% else %}
          {% if player_avail %}
            {% if player_avail.status == 'M' %}
              <p class="text-muted">No response yet.</p>
            {% else %}
              <p class="text-muted">Your current availability: <strong>{{ player_avail.get_status_display }}</strong></p>
            {% endif %}
          {% elif player %}
            <a class="btn btn-primary" href="{% url 'availability_update' upcoming.id %}">Set availability</a>
          {% endif %}
        {% endif %}
        {% if user.is_authenticated %}
          {% if user.is_staff %}
            {% if upcoming.is_bye %}
            <div class="mt-2 d-flex flex-column gap-2">
              <div class="text-muted small">Bye week — lineup not applicable, but Sub Availability can be managed.</div>
              <div>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'admin_availability_matrix' upcoming.id %}">Availability</a>
              </div>
            </div>
            {% else %}
            <div class="mt-2 d-flex gap-2">
              <a class="btn btn-sm btn-primary" href="{% url 'admin_availability_matrix' upcoming.id %}">Availability</a>
              <a class="btn btn-sm btn-primary" href="{% url 'admin_lineup_builder' upcoming.id %}">Lineup</a>
            </div>
            {% endif %}
          {% elif user.player_profile and user.player_profile.is_captain %}
            {% if upcoming.is_bye %}
            <div class="mt-2 d-flex flex-column gap-2">
              <div class="text-muted small">Bye week — lineup not applicable, but Sub Availability can be managed.</div>
              <div>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'admin_availability_matrix' upcoming.id %}">Availability</a>
              </div>
            </div>
            {% else %}
            <div class="mt-2 d-flex gap-2">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'admin_availability_matrix' upcoming.id %}">Availability</a>
              <a class="btn btn-sm btn-primary" href="{% url 'admin_lineup_builder' upcoming.id %}">Lineup</a>
            </div>
            {% endif %}
          {% endif %}
        {% endif %}
        {% if upcoming.is_bye %}
          <hr>
          <p class="text-muted mb-0"><span class="badge bg-secondary">BYE</span> No lineup for bye weeks.</p>
        {% elif upcoming.lineup and upcoming.lineup.published %}
          <hr>
          <h6>Selected lineup</h6>
          <ul class="list-group list-group-flush mb-0 glass-list">
            <li class="list-group-item bg-transparent fw-semibold small text-uppercase text-muted">Singles</li>
            {% for slot in upcoming.lineup.slots.all %}
              {% if slot.slot|slice:":1" == "S" %}
                <li class="list-group-item bg-transparent">{{ slot.get_slot_display }} — {{ slot.player1 }}</li>
              {% endif %}
            {% endfor %}
            <li class="list-group-item bg-transparent fw-semibold small text-uppercase text-muted mt-1">Doubles</li>
            {% for slot in upcoming.lineup.slots.all %}
              {% if slot.slot|slice:":1" == "D" %}
                <li class="list-group-item bg-transparent">{{ slot.get_slot_display }} — {{ slot.player1 }} {% if slot.player2 %}/ {{ slot.player2 }}{% endif %}</li>
              {% endif %}
            {% endfor %}
          </ul>
        {% elif upcoming.lineup %}
          <hr>
          <p class="text-muted mb-0">Lineup in progress</p>
        {% endif %}
        <a class="stretched-link" href="{% url 'fixture_detail' upcoming.id %}" aria-label="Open fixture details: {{ upcoming }}"></a>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-12 col-md-6">
    <div class="card glass-card h-100">
      <div class="card-body">
        <p class="mb-0">No upcoming matches yet.</p>
      </div>
    </div>
  </div>
  {% endif %}
</div>
<div class="mb-5"></div>

<div class="position-fixed bottom-0 end-0 p-3 z-1080">
  <div id="dashToast" class="toast align-items-center text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="dashToastBody">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}

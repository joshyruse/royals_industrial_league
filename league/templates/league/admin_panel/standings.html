{% extends "league/base.html" %}
{% load static %}

{% block title %}Manage League Standings{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Manage League Standings</h2>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">← Back to Admin Dashboard</a>
  </div>

  {# flash messages #}
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if active %}
    <div class="mb-3 small text-muted">
      Active season: <strong>{{ active }}</strong>
    </div>
  {% endif %}

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card glass-card">
        <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Edit Standings (Draft)</h5>
        </div>
        <div class="card-body">

          <form method="post" action="{% url 'admin_league_standings' %}">
            {% csrf_token %}

            <div class="table-responsive table-scroll-70">
              <table class="table table-hover align-middle mb-0 glass-table table-glass-transparent table-compact">
                <thead class="table-head-glass">
                  <tr>
                    <th scope="col" class="col-team">Team</th>
                    <th scope="col" class="col-points text-end text-nowrap" style="width:1%;">Points</th>
                  </tr>
                </thead>
                <tbody>
                  {# Royals — calculated automatically #}
                  {% if royals %}
                    <tr>
                      <td>
                        <input type="text" class="form-control" value="Royals" disabled>
                      </td>
                      <td class="w-25">
                        <input type="text" class="form-control" value="{{ royals.points|default_if_none:'0' }}" disabled>
                      </td>
                    </tr>
                  {% endif %}

                  {# Exactly six editable rows, prefilled from initial_rows passed by the view #}
                  {% for row in initial_rows %}
                    <tr>
                      <td>
                        <input type="text" name="standings-{{ forloop.counter0 }}-team_name"
                               class="form-control"
                               placeholder="Team name"
                               value="{{ row.name }}">
                      </td>
                      <td class="text-end text-nowrap">
                        <input type="number"
                               step="0.01" min="0"
                               name="standings-{{ forloop.counter0 }}-points"
                               class="form-control d-inline-block text-end"
                               style="max-width: 7rem;"
                               placeholder="0"
                               value="{{ row.points }}">
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" name="action" value="save" class="btn btn-secondary">Save Draft</button>
              <button type="submit" name="action" value="publish" class="btn btn-primary">Publish</button>
            </div>
          </form>

          <p class="text-muted small mt-2 mb-0">
            Tip: “Save Draft” stores values but does not show to players. “Publish” makes standings visible on player dashboards.
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card glass-card h-100">
        <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Preview (Sorted)</h5>
          {% if standings_published %}
            <span class="badge bg-success">Published</span>
          {% else %}
            <span class="badge bg-warning text-dark">Draft</span>
          {% endif %}
        </div>
        <div class="card-body">
          {% if standings_rows %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0 glass-table table-glass-transparent table-compact">
                <thead class="table-head-glass">
                  <tr>
                    <th scope="col" class="col-rank text-muted" style="width:2.5rem;">#</th>
                    <th scope="col" class="col-team">Team</th>
                    <th scope="col" class="col-points text-end text-nowrap" style="width:1%;">Points</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in standings_rows %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>
                        {{ s.team_name }}
                        {% if s.is_royals %}<span class="badge rounded-pill bg-primary ms-2">Royals</span>{% endif %}
                      </td>
                      <td class="text-end text-nowrap fw-semibold">{{ s.points|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">No standings yet. Save a draft to preview.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
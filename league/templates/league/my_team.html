{% extends "league/base.html" %}
{% load static %}
{% load phonefmt %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">My Team</h1>
  <form method="get" class="d-inline-flex align-items-center">
    <label class="me-2 mb-0" for="season">Season</label>
    <select class="form-select theme-select" name="season" id="season" onchange="this.form.submit()">
      {% for s in seasons %}
        <option value="{{ s.id }}" {% if selected_season and s.id == selected_season.id %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<div class="glass-card p-3 mb-3">
  <h2 class="h6 text-muted mb-3">Sharing Preferences</h2>
  <form method="post" class="row g-3">
    {% csrf_token %}
    <div class="col-md-4 form-check">
      {{ form.share_email_with_team }} <label class="form-check-label" for="{{ form.share_email_with_team.id_for_label }}">Share Email with Team</label>
    </div>
    <div class="col-md-4 form-check">
      {{ form.share_mobile_with_team }} <label class="form-check-label" for="{{ form.share_mobile_with_team.id_for_label }}">Share Mobile with Team</label>
    </div>
    <div class="col-md-4 text-md-end">
      <button class="btn btn-primary">Save</button>
    </div>
  </form>
  <div class="mt-2 small text-body">
    Only teammates who have opted in will display their contact details below.
  </div>
</div>

<div class="glass-card p-3">
  {% if selected_season and roster_entries %}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 text-muted mb-0">Roster — {{ selected_season }}</h2>
    </div>
    <div class="table-responsive table-scroll-70">
      <table class="table glass-table table-hover table-compact table-glass-transparent align-middle mb-0">
        <thead class="table-head-glass">
          <tr>
            <th>First</th>
            <th>Last</th>
            <th>NTRP</th>
            <th>Email</th>
            <th>Mobile</th>
          </tr>
        </thead>
        <tbody>
        {% for entry in roster_entries %}
          {% with p=entry.player prefs=entry.prefs %}
          <tr>
            <td>{{ p.first_name }}</td>
            <td>{{ p.last_name }}</td>
            <td>{{ entry.ntrp|default:"—" }}</td>
            <td>
              {% if prefs and prefs.share_email_with_team %}
                {% if p.email %}
                  <a href="mailto:{{ p.email }}">{{ p.email }}</a>
                {% elif p.user.email %}
                  <a href="mailto:{{ p.user.email }}">{{ p.user.email }}</a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if prefs and prefs.share_mobile_with_team and prefs.phone_verified_at and prefs.phone_e164 %}
                {{ prefs.phone_e164|us_format_e164 }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr><td colspan="5" class="text-muted">No players found.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted mb-0">We couldn’t find your roster for {{ selected_season|default:"the selected season" }}.</p>
  {% endif %}
</div>
{% endblock %}
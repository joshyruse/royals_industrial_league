{% extends "league/base.html" %}
{% load static %}
{% block content %}
<h1 class="h4 mb-3">Account Profile</h1>
<form method="post" class="glass-card p-3" novalidate>
  {% csrf_token %}
  <div class="mb-2">
    <a class="text-secondary text-decoration-none d-inline-flex align-items-center" data-bs-toggle="collapse" href="#profileSection" role="button" aria-expanded="false" aria-controls="profileSection">
      <i class="bi bi-chevron-right me-2" id="icon-profile"></i>
      <h2 class="h5 mb-0">Personal Details</h2>
    </a>
  </div>
  <div id="profileSection" class="collapse">
    <div class="row g-3">
      <div class="col-md-6">{{ form.first_name.label_tag }} {{ form.first_name }}</div>
      <div class="col-md-6">{{ form.last_name.label_tag }} {{ form.last_name }}</div>
      <div class="col-md-6">{{ form.email.label_tag }} {{ form.email }}</div>
      {% with prefs=request.user.notificationpreference %}
      <div class="col-md-6">
        <label class="form-label">Mobile phone (SMS)</label>
        <div class="input-group">
          <span class="input-group-text">+1</span>
          <input type="text" class="form-control placeholder-contrast" id="display-sms-phone" value="{% if prefs and prefs.phone_e164 and prefs.phone_verified_at %}({{ prefs.phone_e164|slice:'2:5' }}) {{ prefs.phone_e164|slice:'5:8' }}-{{ prefs.phone_e164|slice:'8:12' }}{% endif %}" placeholder="Add your mobile via Verify" readonly>
        </div>
        <div class="d-flex align-items-center mt-2">
          {% if SMS_FEATURE_ENABLED %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#smsVerifyModal" id="openVerifyBtn">
              {% if prefs and prefs.phone_verified_at %}Re-Verify{% else %}Verify{% endif %}
            </button>
            <span id="phone-verify-status" class="badge ms-2 {% if prefs and prefs.phone_verified_at %}bg-success{% else %}bg-secondary{% endif %}">{% if prefs and prefs.phone_verified_at %}Verified{% else %}Not verified{% endif %}</span>
          {% else %}
            <button type="button" class="btn btn-secondary" id="openVerifyBtn" disabled data-bs-toggle="tooltip" title="SMS temporarily disabled while registration is pending">
              Verify
            </button>
            <span id="phone-verify-status" class="badge ms-2 bg-secondary">Unavailable</span>
          {% endif %}
        </div>
        {% if not SMS_FEATURE_ENABLED %}
          <div class="form-text text-muted fst-italic mt-1 help-contrast">SMS verification is temporarily disabled in this environment.</div>
        {% endif %}
      </div>
      {% endwith %}
    </div>
    <hr class="my-4">
    <div class="mt-3 mb-4">
      <button class="btn btn-primary" name="save" value="profile">Save Profile</button>
      <a class="btn btn-outline-secondary cancel-section" data-section="profileSection" href="{% url 'profile_edit' %}">
        Cancel
      </a>
    </div>
  </div>
  <div class="mb-2">
    <a class="text-secondary text-decoration-none d-inline-flex align-items-center" data-bs-toggle="collapse" href="#notifSection" role="button" aria-expanded="false" aria-controls="notifSection">
      <i class="bi bi-chevron-right me-2" id="icon-notif"></i>
      <h2 class="h5 mb-0">Notification Settings</h2>
    </a>
  </div>
  <div id="notifSection" class="collapse">
    {% if prefs_form.non_field_errors %}
      <div class="alert alert-danger">{{ prefs_form.non_field_errors }}</div>
    {% endif %}
    <div class="glass-card p-3 mb-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Enable Email</label>
          {{ prefs_form.email_enabled }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Enable SMS</label>
          {% if SMS_FEATURE_ENABLED %}
            {{ prefs_form.sms_enabled }}
          {% else %}
            <input type="checkbox" class="form-check-input" id="id_sms_enabled_disabled"
                   {% if prefs_form.sms_enabled.value %}checked{% endif %} disabled>
            <input type="hidden" name="{{ prefs_form.sms_enabled.html_name }}" value="{% if prefs_form.sms_enabled.value %}on{% endif %}">
          {% endif %}
          {% if SMS_FEATURE_ENABLED %}
            <div id="sms-preverify-hint" class="form-text text-muted fst-italic help-contrast {% if prefs and prefs.phone_verified_at %}d-none{% endif %}">Verify phone to enable SMS notification settings.</div>
            <div id="sms-enable-hint" class="form-text text-success help-contrast {% if not prefs or not prefs.phone_verified_at %}d-none{% endif %}">You can now enable SMS notifications.</div>
          {% else %}
            <div class="form-text text-muted fst-italic">SMS notifications are disabled in this environment.</div>
          {% endif %}
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        {% if request.user.is_staff or request.user.player_profile and request.user.player_profile.is_captain %}
          <div class="col-md-6">
            <h6 class="text-muted">Captain / Admin</h6>
            <div class="form-check">{{ prefs_form.lineup_overdue_staff_email }} <label class="form-check-label">Lineup overdue (email)</label></div>
            <div class="form-check">{{ prefs_form.scores_overdue_staff_email }} <label class="form-check-label">Scores overdue (email)</label></div>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Player</h6>
            <div class="form-check">{{ prefs_form.lineup_published_email }} <label class="form-check-label">Lineup published (email)</label></div>
            <div class="form-check">{{ prefs_form.lineup_published_sms }} <label class="form-check-label">Lineup published (SMS)</label></div>
            <div class="form-check">{{ prefs_form.subplan_created_email }} <label class="form-check-label">Sub match created (email)</label></div>
            <div class="form-check">{{ prefs_form.subplan_created_sms }} <label class="form-check-label">Sub match created (SMS)</label></div>
            <div class="form-check">{{ prefs_form.result_posted_email }} <label class="form-check-label">Result posted (email)</label></div>
            <div class="form-check">{{ prefs_form.result_posted_sms }} <label class="form-check-label">Result posted (SMS)</label></div>
            <div class="form-check">{{ prefs_form.match_reminder_24h_email }} <label class="form-check-label">Match reminder 24h (email)</label></div>
            <div class="form-check">{{ prefs_form.match_reminder_24h_sms }} <label class="form-check-label">Match reminder 24h (SMS)</label></div>
            <div class="form-check">{{ prefs_form.availability_reminder_5d_email }} <label class="form-check-label">Availability reminder 5d (email)</label></div>
            <div class="form-check">{{ prefs_form.availability_reminder_5d_sms }} <label class="form-check-label">Availability reminder 5d (SMS)</label></div>
          </div>
        {% else %}
          <div class="col-md-12">
            <h6 class="text-muted">Player</h6>
            <div class="form-check">{{ prefs_form.lineup_published_email }} <label class="form-check-label">Lineup published (email)</label></div>
            <div class="form-check">{{ prefs_form.lineup_published_sms }} <label class="form-check-label">Lineup published (SMS)</label></div>
            <div class="form-check">{{ prefs_form.subplan_created_email }} <label class="form-check-label">Sub match created (email)</label></div>
            <div class="form-check">{{ prefs_form.subplan_created_sms }} <label class="form-check-label">Sub match created (SMS)</label></div>
            <div class="form-check">{{ prefs_form.result_posted_email }} <label class="form-check-label">Result posted (email)</label></div>
            <div class="form-check">{{ prefs_form.result_posted_sms }} <label class="form-check-label">Result posted (SMS)</label></div>
            <div class="form-check">{{ prefs_form.match_reminder_24h_email }} <label class="form-check-label">Match reminder 24h (email)</label></div>
            <div class="form-check">{{ prefs_form.match_reminder_24h_sms }} <label class="form-check-label">Match reminder 24h (SMS)</label></div>
            <div class="form-check">{{ prefs_form.availability_reminder_5d_email }} <label class="form-check-label">Availability reminder 5d (email)</label></div>
            <div class="form-check">{{ prefs_form.availability_reminder_5d_sms }} <label class="form-check-label">Availability reminder 5d (SMS)</label></div>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="mt-3 mb-4">
      <button class="btn btn-primary" name="save" value="notifications">Save Notification Settings</button>
      <a class="btn btn-outline-secondary cancel-section" data-section="notifSection" href="{% url 'profile_edit' %}">
        Cancel
      </a>
    </div>
  </div>  {# end notifSection collapse #}

  <div class="mb-2">
    <a class="text-secondary text-decoration-none d-inline-flex align-items-center" data-bs-toggle="collapse" href="#securitySection" role="button" aria-expanded="false" aria-controls="securitySection">
      <i class="bi bi-chevron-right me-2" id="icon-security"></i>
      <h2 class="h5 mb-0">Login Security</h2>
    </a>
  </div>
  <div id="securitySection" class="collapse">
    <div class="glass-card p-3 mb-3">
      {% if username_form.non_field_errors %}
        <div class="alert alert-danger mb-3">{{ username_form.non_field_errors }}</div>
      {% endif %}
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          {{ username_form.username.label_tag }}
          {{ username_form.username }}
          {% if username_form.username.errors %}
            <div class="text-danger small">{{ username_form.username.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-md-6 text-md-end">
          <button class="btn btn-primary mt-2 mt-md-0" name="save" value="security_username">Save Username</button>
        </div>
      </div>
    </div>

    <div class="glass-card p-3">
      {% if pwd_form.non_field_errors %}
        <div class="alert alert-danger mb-3">{{ pwd_form.non_field_errors }}</div>
      {% endif %}
      <div class="row g-3">
        <div class="col-12 mb-2">
          <label class="form-label" for="{{ pwd_form.old_password.id_for_label }}">Current Password</label>
          <div class="input-group">
            {{ pwd_form.old_password }}
            <button class="btn btn-outline-secondary toggle-pass" type="button" data-target-id="{{ pwd_form.old_password.id_for_label }}" aria-label="Show password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {% if pwd_form.old_password.errors %}
            <div class="text-danger small">{{ pwd_form.old_password.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-12 mb-2">
          <label class="form-label" for="{{ pwd_form.new_password1.id_for_label }}">New Password</label>
          <div class="input-group">
            {{ pwd_form.new_password1 }}
            <button class="btn btn-outline-secondary toggle-pass" type="button" data-target-id="{{ pwd_form.new_password1.id_for_label }}" aria-label="Show password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {% if pwd_form.new_password1.help_text %}
            <div class="form-text small">{{ pwd_form.new_password1.help_text|safe }}</div>
          {% endif %}
          {% if pwd_form.new_password1.errors %}
            <div class="text-danger small">{{ pwd_form.new_password1.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <label class="form-label" for="{{ pwd_form.new_password2.id_for_label }}">Reenter Password</label>
          <div class="input-group">
            {{ pwd_form.new_password2 }}
            <button class="btn btn-outline-secondary toggle-pass" type="button" data-target-id="{{ pwd_form.new_password2.id_for_label }}" aria-label="Show password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {% if pwd_form.new_password2.errors %}
            <div class="text-danger small">{{ pwd_form.new_password2.errors|join:', ' }}</div>
          {% endif %}
        </div>
      </div>
      <div class="mt-3 mb-2">
        <button class="btn btn-primary" name="save" value="security_password">Save New Password</button>
        <a class="btn btn-outline-secondary cancel-section" data-section="securitySection" href="{% url 'profile_edit' %}">
          Cancel
        </a>
      </div>
    </div>
  </div>  {# end securitySection collapse #}

</form>

{% if SMS_FEATURE_ENABLED %}
<!-- SMS Verification Modal -->
<div class="modal fade" id="smsVerifyModal" tabindex="-1" aria-labelledby="smsVerifyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content glass-card p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="smsVerifyModalLabel">Verify your phone</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="sms-verify-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="sms-phone" class="form-label">Mobile number</label>
            <div class="input-group">
              <span class="input-group-text">+1</span>
            <input type="text" class="form-control placeholder-contrast" id="sms-phone" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="(317) 555-0123 (digits only)">
          </div>
          <div class="form-text help-contrast">Enter digits only. Weâ€™ll format it as (XXX) XXX-XXXX.</div>
          </div>
          <div class="mb-3">
            <button type="button" id="send-otp-btn" class="btn btn-outline-secondary w-100">Send code</button>
            <div id="otp-sent-msg" class="form-text text-success d-none help-contrast">Code sent! Check your phone.</div>
          </div>
          <div class="mb-3">
            <label for="sms-code" class="form-label">Enter code</label>
            <input type="text" class="form-control" id="sms-code" maxlength="6" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input bg-purple border-purple" type="checkbox" value="true" id="sms-consent">
            <label class="form-check-label" for="sms-consent">
              I agree to receive Royals Industrial League SMS updates. Message frequency may vary. Message &amp; data rates may apply. Reply STOP to opt out, HELP for help.
            </label>
            <label class="form-check-label fw-bold" for="sms-consent">
              Your mobile information will not be sold or shared with third parties for promotional or marketing purposes.
            </label>
          </div>
          <button type="button" id="verify-otp-btn" class="btn btn-primary w-100" disabled aria-disabled="true">Verify &amp; Consent</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="{% static 'js/player_profile_form.js' %}" defer></script>
{% endblock %}